// This file is autogenerated by test_variations. Do not edit; regenerate
#include <stdint.h>

#ifndef FLOW_GCC_IDCT
#define JPEG_INTERNALS
#include <stdio.h>
#include "jpeglib.h"
#include "jdct.h" /* Private declarations for DCT subsystem */
#endif

#if defined(__GNUC__) && !defined(__clang__)
#define HOT __attribute__((hot)) __attribute__((optimize("-funsafe-math-optimizations", "-ftree-vectorize")))
#else
#if defined(__GNUC__)
#define HOT __attribute__((hot))
#else
#define HOT
#endif
#endif
#ifdef _MSC_VER
#define FLOW_EXPORT __declspec(dllexport)
#define FLOW_ALIGN_16 __declspec(align(16))
#define FLOW_ALIGN_16_VAR(X) __declspec(align(16)) X
#else
#define FLOW_EXPORT
#define FLOW_ALIGN_16 __attribute__((aligned(16)))
#define FLOW_ALIGN_16_VAR(X) X __attribute__((aligned(16)))
#endif

FLOW_EXPORT void flow_scale_spatial_srgb_7x7(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col) HOT;

FLOW_EXPORT void flow_scale_spatial_srgb_6x6(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col) HOT;

FLOW_EXPORT void flow_scale_spatial_srgb_5x5(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col) HOT;

FLOW_EXPORT void flow_scale_spatial_srgb_4x4(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col) HOT;

FLOW_EXPORT void flow_scale_spatial_srgb_3x3(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col) HOT;

FLOW_EXPORT void flow_scale_spatial_srgb_2x2(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col) HOT;

FLOW_EXPORT void flow_scale_spatial_srgb_1x1(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col) HOT;

FLOW_EXPORT void flow_scale_spatial_7x7(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col) HOT;

FLOW_EXPORT void flow_scale_spatial_6x6(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col) HOT;

FLOW_EXPORT void flow_scale_spatial_5x5(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col) HOT;

FLOW_EXPORT void flow_scale_spatial_4x4(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col) HOT;

FLOW_EXPORT void flow_scale_spatial_3x3(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col) HOT;

FLOW_EXPORT void flow_scale_spatial_2x2(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col) HOT;

FLOW_EXPORT void flow_scale_spatial_1x1(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col) HOT;

#ifndef FLOW_GCC_IDCT
void jpeg_idct_spatial_srgb_7x7(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col) HOT;

void jpeg_idct_spatial_srgb_6x6(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col) HOT;

void jpeg_idct_spatial_srgb_5x5(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col) HOT;

void jpeg_idct_spatial_srgb_4x4(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col) HOT;

void jpeg_idct_spatial_srgb_3x3(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col) HOT;

void jpeg_idct_spatial_srgb_2x2(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col) HOT;

void jpeg_idct_spatial_srgb_1x1(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col) HOT;

void jpeg_idct_spatial_7x7(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col) HOT;

void jpeg_idct_spatial_6x6(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col) HOT;

void jpeg_idct_spatial_5x5(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col) HOT;

void jpeg_idct_spatial_4x4(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col) HOT;

void jpeg_idct_spatial_3x3(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col) HOT;

void jpeg_idct_spatial_2x2(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col) HOT;

void jpeg_idct_spatial_1x1(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col) HOT;

#endif

FLOW_ALIGN_16 static const uint8_t lut_linear_to_srgb[4096] = {
    0,   1,   2,   3,   3,   4,   5,   6,   7,   7,   8,   9,   10,  11,  11,  12,  13,  13,  14,  15,  15,  16,  17,
    17,  18,  18,  19,  19,  20,  20,  21,  21,  22,  22,  23,  23,  23,  24,  24,  25,  25,  26,  26,  26,  27,  27,
    27,  28,  28,  29,  29,  29,  30,  30,  30,  31,  31,  31,  32,  32,  32,  33,  33,  33,  34,  34,  34,  35,  35,
    35,  35,  36,  36,  36,  37,  37,  37,  37,  38,  38,  38,  38,  39,  39,  39,  40,  40,  40,  40,  41,  41,  41,
    41,  42,  42,  42,  42,  43,  43,  43,  43,  44,  44,  44,  44,  44,  45,  45,  45,  45,  46,  46,  46,  46,  47,
    47,  47,  47,  47,  48,  48,  48,  48,  48,  49,  49,  49,  49,  49,  50,  50,  50,  50,  51,  51,  51,  51,  51,
    52,  52,  52,  52,  52,  52,  53,  53,  53,  53,  53,  54,  54,  54,  54,  54,  55,  55,  55,  55,  55,  55,  56,
    56,  56,  56,  56,  57,  57,  57,  57,  57,  57,  58,  58,  58,  58,  58,  59,  59,  59,  59,  59,  59,  60,  60,
    60,  60,  60,  60,  61,  61,  61,  61,  61,  61,  61,  62,  62,  62,  62,  62,  62,  63,  63,  63,  63,  63,  63,
    64,  64,  64,  64,  64,  64,  64,  65,  65,  65,  65,  65,  65,  66,  66,  66,  66,  66,  66,  66,  67,  67,  67,
    67,  67,  67,  67,  68,  68,  68,  68,  68,  68,  68,  69,  69,  69,  69,  69,  69,  69,  70,  70,  70,  70,  70,
    70,  70,  71,  71,  71,  71,  71,  71,  71,  72,  72,  72,  72,  72,  72,  72,  73,  73,  73,  73,  73,  73,  73,
    73,  74,  74,  74,  74,  74,  74,  74,  74,  75,  75,  75,  75,  75,  75,  75,  76,  76,  76,  76,  76,  76,  76,
    76,  77,  77,  77,  77,  77,  77,  77,  77,  78,  78,  78,  78,  78,  78,  78,  78,  79,  79,  79,  79,  79,  79,
    79,  79,  79,  80,  80,  80,  80,  80,  80,  80,  80,  81,  81,  81,  81,  81,  81,  81,  81,  81,  82,  82,  82,
    82,  82,  82,  82,  82,  83,  83,  83,  83,  83,  83,  83,  83,  83,  84,  84,  84,  84,  84,  84,  84,  84,  84,
    85,  85,  85,  85,  85,  85,  85,  85,  85,  86,  86,  86,  86,  86,  86,  86,  86,  86,  87,  87,  87,  87,  87,
    87,  87,  87,  87,  88,  88,  88,  88,  88,  88,  88,  88,  88,  88,  89,  89,  89,  89,  89,  89,  89,  89,  89,
    90,  90,  90,  90,  90,  90,  90,  90,  90,  90,  91,  91,  91,  91,  91,  91,  91,  91,  91,  91,  92,  92,  92,
    92,  92,  92,  92,  92,  92,  92,  93,  93,  93,  93,  93,  93,  93,  93,  93,  93,  94,  94,  94,  94,  94,  94,
    94,  94,  94,  94,  95,  95,  95,  95,  95,  95,  95,  95,  95,  95,  96,  96,  96,  96,  96,  96,  96,  96,  96,
    96,  96,  97,  97,  97,  97,  97,  97,  97,  97,  97,  97,  98,  98,  98,  98,  98,  98,  98,  98,  98,  98,  98,
    99,  99,  99,  99,  99,  99,  99,  99,  99,  99,  99,  100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 101,
    101, 101, 101, 101, 101, 101, 101, 101, 101, 101, 102, 102, 102, 102, 102, 102, 102, 102, 102, 102, 102, 103, 103,
    103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 104, 104, 104, 104, 104, 104, 104, 104, 104, 104, 104, 105, 105,
    105, 105, 105, 105, 105, 105, 105, 105, 105, 105, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 106, 107,
    107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108,
    109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 110, 110, 110, 110, 110, 110, 110, 110, 110, 110, 110,
    110, 111, 111, 111, 111, 111, 111, 111, 111, 111, 111, 111, 111, 111, 112, 112, 112, 112, 112, 112, 112, 112, 112,
    112, 112, 112, 113, 113, 113, 113, 113, 113, 113, 113, 113, 113, 113, 113, 113, 114, 114, 114, 114, 114, 114, 114,
    114, 114, 114, 114, 114, 114, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 116, 116, 116, 116,
    116, 116, 116, 116, 116, 116, 116, 116, 116, 117, 117, 117, 117, 117, 117, 117, 117, 117, 117, 117, 117, 117, 118,
    118, 118, 118, 118, 118, 118, 118, 118, 118, 118, 118, 118, 118, 119, 119, 119, 119, 119, 119, 119, 119, 119, 119,
    119, 119, 119, 119, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 121, 121, 121, 121, 121, 121,
    121, 121, 121, 121, 121, 121, 121, 121, 122, 122, 122, 122, 122, 122, 122, 122, 122, 122, 122, 122, 122, 122, 123,
    123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 124, 124, 124, 124, 124, 124, 124, 124, 124,
    124, 124, 124, 124, 124, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 126, 126, 126,
    126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
    127, 127, 127, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 129, 129, 129, 129, 129,
    129, 129, 129, 129, 129, 129, 129, 129, 129, 129, 130, 130, 130, 130, 130, 130, 130, 130, 130, 130, 130, 130, 130,
    130, 130, 131, 131, 131, 131, 131, 131, 131, 131, 131, 131, 131, 131, 131, 131, 131, 131, 132, 132, 132, 132, 132,
    132, 132, 132, 132, 132, 132, 132, 132, 132, 132, 133, 133, 133, 133, 133, 133, 133, 133, 133, 133, 133, 133, 133,
    133, 133, 133, 134, 134, 134, 134, 134, 134, 134, 134, 134, 134, 134, 134, 134, 134, 134, 134, 135, 135, 135, 135,
    135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136,
    136, 136, 136, 136, 136, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 138, 138,
    138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 139, 139, 139, 139, 139, 139, 139, 139, 139,
    139, 139, 139, 139, 139, 139, 139, 139, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140,
    140, 140, 141, 141, 141, 141, 141, 141, 141, 141, 141, 141, 141, 141, 141, 141, 141, 141, 141, 142, 142, 142, 142,
    142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 143, 143, 143, 143, 143, 143, 143, 143, 143, 143,
    143, 143, 143, 143, 143, 143, 143, 144, 144, 144, 144, 144, 144, 144, 144, 144, 144, 144, 144, 144, 144, 144, 144,
    144, 145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 146, 146, 146, 146,
    146, 146, 146, 146, 146, 146, 146, 146, 146, 146, 146, 146, 146, 147, 147, 147, 147, 147, 147, 147, 147, 147, 147,
    147, 147, 147, 147, 147, 147, 147, 147, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148,
    148, 148, 148, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 150, 150,
    150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 151, 151, 151, 151, 151, 151,
    151, 151, 151, 151, 151, 151, 151, 151, 151, 151, 151, 151, 152, 152, 152, 152, 152, 152, 152, 152, 152, 152, 152,
    152, 152, 152, 152, 152, 152, 152, 152, 153, 153, 153, 153, 153, 153, 153, 153, 153, 153, 153, 153, 153, 153, 153,
    153, 153, 153, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 155,
    155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 156, 156, 156, 156, 156,
    156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 157, 157, 157, 157, 157, 157, 157, 157, 157,
    157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158,
    158, 158, 158, 158, 158, 158, 158, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159,
    159, 159, 159, 159, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160,
    160, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 162, 162,
    162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 163, 163, 163, 163, 163,
    163, 163, 163, 163, 163, 163, 163, 163, 163, 163, 163, 163, 163, 163, 163, 164, 164, 164, 164, 164, 164, 164, 164,
    164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165,
    165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166,
    166, 166, 166, 166, 166, 166, 166, 166, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167,
    167, 167, 167, 167, 167, 167, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168,
    168, 168, 168, 168, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169,
    169, 169, 169, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
    170, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171,
    172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 173,
    173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 174, 174,
    174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 175, 175, 175,
    175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 176, 176, 176, 176,
    176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 177, 177, 177, 177,
    177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 178, 178, 178, 178, 178,
    178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 179, 179, 179, 179, 179,
    179, 179, 179, 179, 179, 179, 179, 179, 179, 179, 179, 179, 179, 179, 179, 179, 179, 179, 180, 180, 180, 180, 180,
    180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 181, 181, 181, 181, 181,
    181, 181, 181, 181, 181, 181, 181, 181, 181, 181, 181, 181, 181, 181, 181, 181, 181, 181, 182, 182, 182, 182, 182,
    182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 183, 183, 183, 183,
    183, 183, 183, 183, 183, 183, 183, 183, 183, 183, 183, 183, 183, 183, 183, 183, 183, 183, 183, 184, 184, 184, 184,
    184, 184, 184, 184, 184, 184, 184, 184, 184, 184, 184, 184, 184, 184, 184, 184, 184, 184, 184, 184, 185, 185, 185,
    185, 185, 185, 185, 185, 185, 185, 185, 185, 185, 185, 185, 185, 185, 185, 185, 185, 185, 185, 185, 185, 186, 186,
    186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 187,
    187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187,
    188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188,
    188, 188, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189,
    189, 189, 189, 189, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190,
    190, 190, 190, 190, 190, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191,
    191, 191, 191, 191, 191, 191, 191, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192,
    192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193,
    193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194,
    194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 195, 195, 195, 195, 195, 195, 195, 195,
    195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 196, 196, 196, 196, 196, 196,
    196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 197, 197, 197,
    197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197,
    198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198,
    198, 198, 198, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199,
    199, 199, 199, 199, 199, 199, 199, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200,
    200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201,
    201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 202, 202, 202, 202, 202, 202, 202, 202, 202,
    202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 203, 203, 203, 203, 203,
    203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 204,
    204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204,
    204, 204, 204, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205,
    205, 205, 205, 205, 205, 205, 205, 206, 206, 206, 206, 206, 206, 206, 206, 206, 206, 206, 206, 206, 206, 206, 206,
    206, 206, 206, 206, 206, 206, 206, 206, 206, 206, 206, 206, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207,
    207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 208, 208, 208, 208, 208, 208,
    208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 209, 209,
    209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209,
    209, 209, 209, 209, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210,
    210, 210, 210, 210, 210, 210, 210, 210, 210, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211,
    211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 212, 212, 212, 212, 212, 212, 212, 212, 212,
    212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 213, 213, 213,
    213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213,
    213, 213, 213, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214,
    214, 214, 214, 214, 214, 214, 214, 214, 214, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215,
    215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 216, 216, 216, 216, 216, 216, 216, 216,
    216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 217, 217,
    217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217,
    217, 217, 217, 217, 217, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218,
    218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219,
    219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 220, 220, 220, 220, 220,
    220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220,
    220, 220, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221,
    221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222,
    222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 223, 223, 223, 223, 223, 223,
    223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223,
    223, 223, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224,
    224, 224, 224, 224, 224, 224, 224, 224, 224, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225,
    225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 226, 226, 226, 226, 226, 226,
    226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226,
    226, 226, 226, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227,
    227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228,
    228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 229, 229, 229, 229,
    229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229,
    229, 229, 229, 229, 229, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230,
    230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 231, 231, 231, 231, 231, 231, 231, 231, 231,
    231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231,
    232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232,
    232, 232, 232, 232, 232, 232, 232, 232, 232, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233,
    233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 234, 234, 234, 234,
    234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234,
    234, 234, 234, 234, 234, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235,
    235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 236, 236, 236, 236, 236, 236, 236, 236,
    236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
    236, 236, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237,
    237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238,
    238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238,
    239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239,
    239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240,
    240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 241, 241,
    241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
    241, 241, 241, 241, 241, 241, 241, 241, 241, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242,
    242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 243, 243, 243,
    243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243,
    243, 243, 243, 243, 243, 243, 243, 243, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244,
    244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 245, 245, 245,
    245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245,
    245, 245, 245, 245, 245, 245, 245, 245, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246,
    246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 247, 247, 247,
    247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247,
    247, 247, 247, 247, 247, 247, 247, 247, 247, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248,
    248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 249, 249,
    249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249,
    249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250,
    250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250,
    251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251,
    251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252,
    252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252,
    252, 252, 252, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253,
    253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 254, 254, 254, 254, 254, 254, 254,
    254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254,
    254, 254, 254, 254, 254, 254, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
    255, 255,
};

FLOW_ALIGN_16 static const uint16_t lut_srgb_to_linear[256] = {
    0,    1,    2,    4,    5,    6,    7,    9,    10,   11,   12,   14,   15,   16,   18,   20,   21,   23,   25,
    27,   29,   31,   33,   35,   37,   40,   42,   45,   48,   50,   53,   56,   59,   62,   66,   69,   72,   76,
    79,   83,   87,   91,   95,   99,   103,  107,  112,  116,  121,  126,  131,  136,  141,  146,  151,  156,  162,
    168,  173,  179,  185,  191,  197,  204,  210,  216,  223,  230,  237,  244,  251,  258,  265,  273,  280,  288,
    296,  304,  312,  320,  329,  337,  346,  354,  363,  372,  381,  390,  400,  409,  419,  428,  438,  448,  458,
    469,  479,  490,  500,  511,  522,  533,  544,  555,  567,  578,  590,  602,  614,  626,  639,  651,  664,  676,
    689,  702,  715,  728,  742,  755,  769,  783,  797,  811,  825,  840,  854,  869,  884,  899,  914,  929,  945,
    960,  976,  992,  1008, 1024, 1041, 1057, 1074, 1091, 1108, 1125, 1142, 1159, 1177, 1195, 1213, 1231, 1249, 1267,
    1286, 1304, 1323, 1342, 1361, 1381, 1400, 1420, 1440, 1459, 1480, 1500, 1520, 1541, 1562, 1582, 1603, 1625, 1646,
    1668, 1689, 1711, 1733, 1755, 1778, 1800, 1823, 1846, 1869, 1892, 1916, 1939, 1963, 1987, 2011, 2035, 2059, 2084,
    2109, 2133, 2159, 2184, 2209, 2235, 2260, 2286, 2312, 2339, 2365, 2392, 2419, 2446, 2473, 2500, 2527, 2555, 2583,
    2611, 2639, 2668, 2696, 2725, 2754, 2783, 2812, 2841, 2871, 2901, 2931, 2961, 2991, 3022, 3052, 3083, 3114, 3146,
    3177, 3209, 3240, 3272, 3304, 3337, 3369, 3402, 3435, 3468, 3501, 3535, 3568, 3602, 3636, 3670, 3705, 3739, 3774,
    3809, 3844, 3879, 3915, 3950, 3986, 4022, 4059, 4095,
};

FLOW_EXPORT void flow_scale_spatial_7x7(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col)
{
    int32_t i, sum, j;
    FLOW_ALIGN_16_VAR(int32_t temp[48]);
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_0[]) = {
        29,
        3,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_1[]) = {
        -2,
        103,
        27,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_2[]) = {
        -3,
        86,
        45,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_3[]) = {
        -3,
        67,
        67,
        -3,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_4[]) = {
        45,
        86,
        -3,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_5[]) = {
        27,
        103,
        -2,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_6[]) = {
        3,
        29,
    };

    // Begin work for output row 0
    for (i = 0; i < 8; i++)
        temp[i + 0] = 29 * input[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 3 * input[i + 8];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 2; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,0
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 512;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)(sum >> 10));
    // Pixel 0,0 complete

    // Begin work for output pixel 1,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 2048;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 1,0 complete

    // Begin work for output pixel 2,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_2[i];
    sum = 2048;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 2,0 complete

    // Begin work for output pixel 3,0
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_3[i];
    sum = 2048;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 3,0 complete

    // Begin work for output pixel 4,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 2048;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 4,0 complete

    // Begin work for output pixel 5,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_5[i];
    sum = 2048;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 5) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 5,0 complete

    // Begin work for output pixel 6,0
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_6[i];
    sum = 512;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 6) = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)(sum >> 10));
    // Pixel 6,0 complete

    // Begin work for output row 1
    for (i = 0; i < 8; i++)
        temp[i + 0] = -2 * input[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 103 * input[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 27 * input[i + 16];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,1
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 0,1 complete

    // Begin work for output pixel 1,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 1,1 complete

    // Begin work for output pixel 2,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_2[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 2,1 complete

    // Begin work for output pixel 3,1
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 3,1 complete

    // Begin work for output pixel 4,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 4,1 complete

    // Begin work for output pixel 5,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_5[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 5) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 5,1 complete

    // Begin work for output pixel 6,1
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_6[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 6) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 6,1 complete

    // Begin work for output row 2
    for (i = 0; i < 8; i++)
        temp[i + 0] = -3 * input[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 86 * input[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 45 * input[i + 24];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,2
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 0,2 complete

    // Begin work for output pixel 1,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 1,2 complete

    // Begin work for output pixel 2,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_2[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 2,2 complete

    // Begin work for output pixel 3,2
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 3,2 complete

    // Begin work for output pixel 4,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 4,2 complete

    // Begin work for output pixel 5,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_5[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 5) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 5,2 complete

    // Begin work for output pixel 6,2
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_6[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 6) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 6,2 complete

    // Begin work for output row 3
    for (i = 0; i < 8; i++)
        temp[i + 0] = -3 * input[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 67 * input[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 67 * input[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 24] = -3 * input[i + 40];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,3
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 0,3 complete

    // Begin work for output pixel 1,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 1,3 complete

    // Begin work for output pixel 2,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_2[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 2,3 complete

    // Begin work for output pixel 3,3
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 3,3 complete

    // Begin work for output pixel 4,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 4,3 complete

    // Begin work for output pixel 5,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_5[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 5) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 5,3 complete

    // Begin work for output pixel 6,3
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_6[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 6) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 6,3 complete

    // Begin work for output row 4
    for (i = 0; i < 8; i++)
        temp[i + 0] = 45 * input[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 86 * input[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 16] = -3 * input[i + 48];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,4
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 0,4 complete

    // Begin work for output pixel 1,4
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 1,4 complete

    // Begin work for output pixel 2,4
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_2[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 2,4 complete

    // Begin work for output pixel 3,4
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 3,4 complete

    // Begin work for output pixel 4,4
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 4,4 complete

    // Begin work for output pixel 5,4
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_5[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 5) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 5,4 complete

    // Begin work for output pixel 6,4
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_6[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 6) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 6,4 complete

    // Begin work for output row 5
    for (i = 0; i < 8; i++)
        temp[i + 0] = 27 * input[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 103 * input[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 16] = -2 * input[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,5
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 0,5 complete

    // Begin work for output pixel 1,5
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 1,5 complete

    // Begin work for output pixel 2,5
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_2[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 2,5 complete

    // Begin work for output pixel 3,5
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 3,5 complete

    // Begin work for output pixel 4,5
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 4,5 complete

    // Begin work for output pixel 5,5
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_5[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 5) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 5,5 complete

    // Begin work for output pixel 6,5
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_6[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 6) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 6,5 complete

    // Begin work for output row 6
    for (i = 0; i < 8; i++)
        temp[i + 0] = 3 * input[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 29 * input[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 2; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,6
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 512;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[6] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)(sum >> 10));
    // Pixel 0,6 complete

    // Begin work for output pixel 1,6
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 2048;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[6] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 1,6 complete

    // Begin work for output pixel 2,6
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_2[i];
    sum = 2048;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[6] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 2,6 complete

    // Begin work for output pixel 3,6
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_3[i];
    sum = 2048;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[6] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 3,6 complete

    // Begin work for output pixel 4,6
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 2048;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[6] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 4,6 complete

    // Begin work for output pixel 5,6
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_5[i];
    sum = 2048;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[6] + output_col + 5) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 5,6 complete

    // Begin work for output pixel 6,6
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_6[i];
    sum = 512;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[6] + output_col + 6) = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)(sum >> 10));
    // Pixel 6,6 complete
}

#ifndef FLOW_GCC_IDCT
void jpeg_idct_spatial_7x7(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JSAMPLE input[64];
    JSAMPROW rows[8] = { &input[0],     &input[8],     &input[8 * 2], &input[8 * 3],
                         &input[8 * 4], &input[8 * 5], &input[8 * 6], &input[8 * 7] };
    jpeg_idct_islow(cinfo, compptr, coef_block, &rows[0], 0);

    flow_scale_spatial_7x7(input, output_buf, output_col);
}
#endif

FLOW_EXPORT void flow_scale_spatial_6x6(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col)
{
    int32_t i, sum, j;
    FLOW_ALIGN_16_VAR(int32_t temp[48]);
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_0[]) = {
        6,
        2,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_1[]) = {
        -1,
        33,
        33,
        -1,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_2[]) = {
        31,
        92,
        5,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_3[]) = {
        5,
        92,
        31,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_4[]) = {
        -1,
        33,
        33,
        -1,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_5[]) = {
        2,
        6,
    };

    // Begin work for output row 0
    for (i = 0; i < 8; i++)
        temp[i + 0] = 6 * input[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 2 * input[i + 8];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 2; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,0
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 32;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 262144 ? (uint8_t)255 : (uint8_t)(sum >> 6));
    // Pixel 0,0 complete

    // Begin work for output pixel 1,0
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 256;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 2097152 ? (uint8_t)255 : (uint8_t)(sum >> 9));
    // Pixel 1,0 complete

    // Begin work for output pixel 2,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 512;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)(sum >> 10));
    // Pixel 2,0 complete

    // Begin work for output pixel 3,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_3[i];
    sum = 512;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)(sum >> 10));
    // Pixel 3,0 complete

    // Begin work for output pixel 4,0
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 256;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 2097152 ? (uint8_t)255 : (uint8_t)(sum >> 9));
    // Pixel 4,0 complete

    // Begin work for output pixel 5,0
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_5[i];
    sum = 32;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 5) = sum < 0 ? (uint8_t)0 : (sum >= 262144 ? (uint8_t)255 : (uint8_t)(sum >> 6));
    // Pixel 5,0 complete

    // Begin work for output row 1
    for (i = 0; i < 8; i++)
        temp[i + 0] = -1 * input[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 33 * input[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 33 * input[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 24] = -1 * input[i + 24];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,1
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 256;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 2097152 ? (uint8_t)255 : (uint8_t)(sum >> 9));
    // Pixel 0,1 complete

    // Begin work for output pixel 1,1
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 2048;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 1,1 complete

    // Begin work for output pixel 2,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 4096;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)(sum >> 13));
    // Pixel 2,1 complete

    // Begin work for output pixel 3,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_3[i];
    sum = 4096;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)(sum >> 13));
    // Pixel 3,1 complete

    // Begin work for output pixel 4,1
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 2048;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 4,1 complete

    // Begin work for output pixel 5,1
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_5[i];
    sum = 256;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 5) = sum < 0 ? (uint8_t)0 : (sum >= 2097152 ? (uint8_t)255 : (uint8_t)(sum >> 9));
    // Pixel 5,1 complete

    // Begin work for output row 2
    for (i = 0; i < 8; i++)
        temp[i + 0] = 31 * input[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 92 * input[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 5 * input[i + 32];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,2
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 512;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)(sum >> 10));
    // Pixel 0,2 complete

    // Begin work for output pixel 1,2
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)(sum >> 13));
    // Pixel 1,2 complete

    // Begin work for output pixel 2,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 2,2 complete

    // Begin work for output pixel 3,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 3,2 complete

    // Begin work for output pixel 4,2
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)(sum >> 13));
    // Pixel 4,2 complete

    // Begin work for output pixel 5,2
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_5[i];
    sum = 512;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 5) = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)(sum >> 10));
    // Pixel 5,2 complete

    // Begin work for output row 3
    for (i = 0; i < 8; i++)
        temp[i + 0] = 5 * input[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 92 * input[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 31 * input[i + 40];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,3
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 512;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)(sum >> 10));
    // Pixel 0,3 complete

    // Begin work for output pixel 1,3
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)(sum >> 13));
    // Pixel 1,3 complete

    // Begin work for output pixel 2,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 2,3 complete

    // Begin work for output pixel 3,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 3,3 complete

    // Begin work for output pixel 4,3
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)(sum >> 13));
    // Pixel 4,3 complete

    // Begin work for output pixel 5,3
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_5[i];
    sum = 512;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 5) = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)(sum >> 10));
    // Pixel 5,3 complete

    // Begin work for output row 4
    for (i = 0; i < 8; i++)
        temp[i + 0] = -1 * input[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 33 * input[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 33 * input[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 24] = -1 * input[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,4
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 256;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 2097152 ? (uint8_t)255 : (uint8_t)(sum >> 9));
    // Pixel 0,4 complete

    // Begin work for output pixel 1,4
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 2048;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 1,4 complete

    // Begin work for output pixel 2,4
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 4096;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)(sum >> 13));
    // Pixel 2,4 complete

    // Begin work for output pixel 3,4
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_3[i];
    sum = 4096;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)(sum >> 13));
    // Pixel 3,4 complete

    // Begin work for output pixel 4,4
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 2048;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 4,4 complete

    // Begin work for output pixel 5,4
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_5[i];
    sum = 256;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 5) = sum < 0 ? (uint8_t)0 : (sum >= 2097152 ? (uint8_t)255 : (uint8_t)(sum >> 9));
    // Pixel 5,4 complete

    // Begin work for output row 5
    for (i = 0; i < 8; i++)
        temp[i + 0] = 2 * input[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 6 * input[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 2; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,5
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 32;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 262144 ? (uint8_t)255 : (uint8_t)(sum >> 6));
    // Pixel 0,5 complete

    // Begin work for output pixel 1,5
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 256;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 2097152 ? (uint8_t)255 : (uint8_t)(sum >> 9));
    // Pixel 1,5 complete

    // Begin work for output pixel 2,5
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 512;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)(sum >> 10));
    // Pixel 2,5 complete

    // Begin work for output pixel 3,5
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_3[i];
    sum = 512;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)(sum >> 10));
    // Pixel 3,5 complete

    // Begin work for output pixel 4,5
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 256;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 2097152 ? (uint8_t)255 : (uint8_t)(sum >> 9));
    // Pixel 4,5 complete

    // Begin work for output pixel 5,5
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_5[i];
    sum = 32;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 5) = sum < 0 ? (uint8_t)0 : (sum >= 262144 ? (uint8_t)255 : (uint8_t)(sum >> 6));
    // Pixel 5,5 complete
}

#ifndef FLOW_GCC_IDCT
void jpeg_idct_spatial_6x6(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JSAMPLE input[64];
    JSAMPROW rows[8] = { &input[0],     &input[8],     &input[8 * 2], &input[8 * 3],
                         &input[8 * 4], &input[8 * 5], &input[8 * 6], &input[8 * 7] };
    jpeg_idct_islow(cinfo, compptr, coef_block, &rows[0], 0);

    flow_scale_spatial_6x6(input, output_buf, output_col);
}
#endif

FLOW_EXPORT void flow_scale_spatial_5x5(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col)
{
    int32_t i, sum, j;
    FLOW_ALIGN_16_VAR(int32_t temp[48]);
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_0[]) = {
        78,
        51,
        -1,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_1[]) = {
        -2,
        32,
        79,
        19,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_2[]) = {
        1,
        31,
        31,
        1,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_3[]) = {
        19,
        79,
        32,
        -2,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_4[]) = {
        -1,
        51,
        78,
    };

    // Begin work for output row 0
    for (i = 0; i < 8; i++)
        temp[i + 0] = 78 * input[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 51 * input[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 16] = -1 * input[i + 16];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 0,0 complete

    // Begin work for output pixel 1,0
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 1,0 complete

    // Begin work for output pixel 2,0
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)(sum >> 13));
    // Pixel 2,0 complete

    // Begin work for output pixel 3,0
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 3,0 complete

    // Begin work for output pixel 4,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 4,0 complete

    // Begin work for output row 1
    for (i = 0; i < 8; i++)
        temp[i + 0] = -2 * input[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 32 * input[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 79 * input[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 19 * input[i + 24];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 0,1 complete

    // Begin work for output pixel 1,1
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 1,1 complete

    // Begin work for output pixel 2,1
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)(sum >> 13));
    // Pixel 2,1 complete

    // Begin work for output pixel 3,1
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 3,1 complete

    // Begin work for output pixel 4,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 4,1 complete

    // Begin work for output row 2
    for (i = 0; i < 8; i++)
        temp[i + 0] = 1 * input[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 31 * input[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 31 * input[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 1 * input[i + 40];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 4096;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)(sum >> 13));
    // Pixel 0,2 complete

    // Begin work for output pixel 1,2
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)(sum >> 13));
    // Pixel 1,2 complete

    // Begin work for output pixel 2,2
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 2048;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)(sum >> 12));
    // Pixel 2,2 complete

    // Begin work for output pixel 3,2
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_3[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)(sum >> 13));
    // Pixel 3,2 complete

    // Begin work for output pixel 4,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_4[i];
    sum = 4096;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)(sum >> 13));
    // Pixel 4,2 complete

    // Begin work for output row 3
    for (i = 0; i < 8; i++)
        temp[i + 0] = 19 * input[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 79 * input[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 32 * input[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 24] = -2 * input[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 0,3 complete

    // Begin work for output pixel 1,3
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 1,3 complete

    // Begin work for output pixel 2,3
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)(sum >> 13));
    // Pixel 2,3 complete

    // Begin work for output pixel 3,3
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 3,3 complete

    // Begin work for output pixel 4,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 4,3 complete

    // Begin work for output row 4
    for (i = 0; i < 8; i++)
        temp[i + 0] = -1 * input[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 51 * input[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 78 * input[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,4
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 0) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 0,4 complete

    // Begin work for output pixel 1,4
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 1) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 1,4 complete

    // Begin work for output pixel 2,4
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 2) = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)(sum >> 13));
    // Pixel 2,4 complete

    // Begin work for output pixel 3,4
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 3) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 3,4 complete

    // Begin work for output pixel 4,4
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 4) = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)(sum >> 14));
    // Pixel 4,4 complete
}

#ifndef FLOW_GCC_IDCT
void jpeg_idct_spatial_5x5(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JSAMPLE input[64];
    JSAMPROW rows[8] = { &input[0],     &input[8],     &input[8 * 2], &input[8 * 3],
                         &input[8 * 4], &input[8 * 5], &input[8 * 6], &input[8 * 7] };
    jpeg_idct_islow(cinfo, compptr, coef_block, &rows[0], 0);

    flow_scale_spatial_5x5(input, output_buf, output_col);
}
#endif

FLOW_EXPORT void flow_scale_spatial_4x4(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col)
{
    int32_t i, sum, j;
    FLOW_ALIGN_16_VAR(int32_t temp[48]);
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_0[]) = {
        117,
        117,
        22,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_1[]) = {
        21,
        107,
        107,
        21,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_2[]) = {
        21,
        107,
        107,
        21,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_3[]) = {
        22,
        117,
        117,
    };

    // Begin work for output row 0
    for (i = 0; i < 8; i++)
        temp[i + 0] = 117 * input[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 117 * input[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 22 * input[i + 16];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 0,0 complete

    // Begin work for output pixel 1,0
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 1,0 complete

    // Begin work for output pixel 2,0
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_2[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 2,0 complete

    // Begin work for output pixel 3,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_3[i];
    sum = 32768;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 3,0 complete

    // Begin work for output row 1
    for (i = 0; i < 8; i++)
        temp[i + 0] = 21 * input[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 107 * input[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 107 * input[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 21 * input[i + 32];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 0,1 complete

    // Begin work for output pixel 1,1
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 1,1 complete

    // Begin work for output pixel 2,1
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_2[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 2,1 complete

    // Begin work for output pixel 3,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_3[i];
    sum = 32768;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 3,1 complete

    // Begin work for output row 2
    for (i = 0; i < 8; i++)
        temp[i + 0] = 21 * input[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 107 * input[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 107 * input[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 21 * input[i + 48];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 0,2 complete

    // Begin work for output pixel 1,2
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 1,2 complete

    // Begin work for output pixel 2,2
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_2[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 2,2 complete

    // Begin work for output pixel 3,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_3[i];
    sum = 32768;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 3,2 complete

    // Begin work for output row 3
    for (i = 0; i < 8; i++)
        temp[i + 0] = 22 * input[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 117 * input[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 117 * input[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 0,3 complete

    // Begin work for output pixel 1,3
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 1,3 complete

    // Begin work for output pixel 2,3
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_2[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 2,3 complete

    // Begin work for output pixel 3,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_3[i];
    sum = 32768;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 3,3 complete
}

#ifndef FLOW_GCC_IDCT
void jpeg_idct_spatial_4x4(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JSAMPLE input[64];
    JSAMPROW rows[8] = { &input[0],     &input[8],     &input[8 * 2], &input[8 * 3],
                         &input[8 * 4], &input[8 * 5], &input[8 * 6], &input[8 * 7] };
    jpeg_idct_islow(cinfo, compptr, coef_block, &rows[0], 0);

    flow_scale_spatial_4x4(input, output_buf, output_col);
}
#endif

FLOW_EXPORT void flow_scale_spatial_3x3(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col)
{
    int32_t i, sum, j;
    FLOW_ALIGN_16_VAR(int32_t temp[64]);
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_0[]) = {
        80,
        103,
        62,
        11,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_1[]) = {
        2, 39, 87, 87, 39, 2,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_2[]) = {
        11,
        62,
        103,
        80,
    };

    // Begin work for output row 0
    for (i = 0; i < 8; i++)
        temp[i + 0] = 80 * input[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 103 * input[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 62 * input[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 11 * input[i + 24];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[48 + i] = sum;
    }
    // Begin work for output pixel 0,0
    for (i = 0; i < 4; i++)
        temp[56 + i] = temp[48 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[56 + i];
    *(output_rows[0] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 0,0 complete

    // Begin work for output pixel 1,0
    for (i = 0; i < 6; i++)
        temp[56 + i] = temp[49 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 6; i++)
        sum += temp[56 + i];
    *(output_rows[0] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 1,0 complete

    // Begin work for output pixel 2,0
    for (i = 0; i < 4; i++)
        temp[56 + i] = temp[52 + i] * weights_for_col_2[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[56 + i];
    *(output_rows[0] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 2,0 complete

    // Begin work for output row 1
    for (i = 0; i < 8; i++)
        temp[i + 0] = 2 * input[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 39 * input[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 87 * input[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 87 * input[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 32] = 39 * input[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 40] = 2 * input[i + 48];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 6; j++)
            sum += temp[j * 8 + i];

        temp[48 + i] = sum;
    }
    // Begin work for output pixel 0,1
    for (i = 0; i < 4; i++)
        temp[56 + i] = temp[48 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[56 + i];
    *(output_rows[1] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 0,1 complete

    // Begin work for output pixel 1,1
    for (i = 0; i < 6; i++)
        temp[56 + i] = temp[49 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 6; i++)
        sum += temp[56 + i];
    *(output_rows[1] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 1,1 complete

    // Begin work for output pixel 2,1
    for (i = 0; i < 4; i++)
        temp[56 + i] = temp[52 + i] * weights_for_col_2[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[56 + i];
    *(output_rows[1] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 2,1 complete

    // Begin work for output row 2
    for (i = 0; i < 8; i++)
        temp[i + 0] = 11 * input[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 62 * input[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 103 * input[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 80 * input[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[48 + i] = sum;
    }
    // Begin work for output pixel 0,2
    for (i = 0; i < 4; i++)
        temp[56 + i] = temp[48 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[56 + i];
    *(output_rows[2] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 0,2 complete

    // Begin work for output pixel 1,2
    for (i = 0; i < 6; i++)
        temp[56 + i] = temp[49 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 6; i++)
        sum += temp[56 + i];
    *(output_rows[2] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 1,2 complete

    // Begin work for output pixel 2,2
    for (i = 0; i < 4; i++)
        temp[56 + i] = temp[52 + i] * weights_for_col_2[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[56 + i];
    *(output_rows[2] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 2,2 complete
}

#ifndef FLOW_GCC_IDCT
void jpeg_idct_spatial_3x3(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JSAMPLE input[64];
    JSAMPROW rows[8] = { &input[0],     &input[8],     &input[8 * 2], &input[8 * 3],
                         &input[8 * 4], &input[8 * 5], &input[8 * 6], &input[8 * 7] };
    jpeg_idct_islow(cinfo, compptr, coef_block, &rows[0], 0);

    flow_scale_spatial_3x3(input, output_buf, output_col);
}
#endif

FLOW_EXPORT void flow_scale_spatial_2x2(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col)
{
    int32_t i, sum, j;
    FLOW_ALIGN_16_VAR(int32_t temp[64]);
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_0[]) = {
        48, 67, 67, 48, 22, 4,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_1[]) = {
        4, 22, 48, 67, 67, 48,
    };

    // Begin work for output row 0
    for (i = 0; i < 8; i++)
        temp[i + 0] = 48 * input[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 67 * input[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 67 * input[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 48 * input[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 32] = 22 * input[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 40] = 4 * input[i + 40];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 6; j++)
            sum += temp[j * 8 + i];

        temp[48 + i] = sum;
    }
    // Begin work for output pixel 0,0
    for (i = 0; i < 6; i++)
        temp[56 + i] = temp[48 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 6; i++)
        sum += temp[56 + i];
    *(output_rows[0] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 0,0 complete

    // Begin work for output pixel 1,0
    for (i = 0; i < 6; i++)
        temp[56 + i] = temp[50 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 6; i++)
        sum += temp[56 + i];
    *(output_rows[0] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 1,0 complete

    // Begin work for output row 1
    for (i = 0; i < 8; i++)
        temp[i + 0] = 4 * input[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 22 * input[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 48 * input[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 67 * input[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 32] = 67 * input[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 40] = 48 * input[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 6; j++)
            sum += temp[j * 8 + i];

        temp[48 + i] = sum;
    }
    // Begin work for output pixel 0,1
    for (i = 0; i < 6; i++)
        temp[56 + i] = temp[48 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 6; i++)
        sum += temp[56 + i];
    *(output_rows[1] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 0,1 complete

    // Begin work for output pixel 1,1
    for (i = 0; i < 6; i++)
        temp[56 + i] = temp[50 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 6; i++)
        sum += temp[56 + i];
    *(output_rows[1] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)(sum >> 16));
    // Pixel 1,1 complete
}

#ifndef FLOW_GCC_IDCT
void jpeg_idct_spatial_2x2(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JSAMPLE input[64];
    JSAMPROW rows[8] = { &input[0],     &input[8],     &input[8 * 2], &input[8 * 3],
                         &input[8 * 4], &input[8 * 5], &input[8 * 6], &input[8 * 7] };
    jpeg_idct_islow(cinfo, compptr, coef_block, &rows[0], 0);

    flow_scale_spatial_2x2(input, output_buf, output_col);
}
#endif

FLOW_EXPORT void flow_scale_spatial_1x1(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col)
{
    int32_t i, sum, j;
    FLOW_ALIGN_16_VAR(int32_t temp[80]);
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_0[]) = {
        47, 60, 71, 78, 78, 71, 60, 47,
    };

    // Begin work for output row 0
    for (i = 0; i < 8; i++)
        temp[i + 0] = 47 * input[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 60 * input[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 71 * input[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 78 * input[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 32] = 78 * input[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 40] = 71 * input[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 48] = 60 * input[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 56] = 47 * input[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 8; j++)
            sum += temp[j * 8 + i];

        temp[64 + i] = sum;
    }
    // Begin work for output pixel 0,0
    for (i = 0; i < 8; i++)
        temp[72 + i] = temp[64 + i] * weights_for_col_0[i];
    sum = 131072;
    for (i = 0; i < 8; i++)
        sum += temp[72 + i];
    *(output_rows[0] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 1073741824 ? (uint8_t)255 : (uint8_t)(sum >> 18));
    // Pixel 0,0 complete
}

#ifndef FLOW_GCC_IDCT
void jpeg_idct_spatial_1x1(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JSAMPLE input[64];
    JSAMPROW rows[8] = { &input[0],     &input[8],     &input[8 * 2], &input[8 * 3],
                         &input[8 * 4], &input[8 * 5], &input[8 * 6], &input[8 * 7] };
    jpeg_idct_islow(cinfo, compptr, coef_block, &rows[0], 0);

    flow_scale_spatial_1x1(input, output_buf, output_col);
}
#endif

FLOW_EXPORT void flow_scale_spatial_srgb_7x7(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col)
{
    int32_t i, sum, j;
    FLOW_ALIGN_16_VAR(int32_t linearized[64]);
    for (i = 0; i < 64; i++)
        linearized[i] = lut_srgb_to_linear[input[i]];

    FLOW_ALIGN_16_VAR(int32_t temp[48]);
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_0[]) = {
        29,
        3,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_1[]) = {
        -2,
        103,
        27,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_2[]) = {
        -3,
        86,
        45,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_3[]) = {
        -3,
        67,
        67,
        -3,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_4[]) = {
        45,
        86,
        -3,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_5[]) = {
        27,
        103,
        -2,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_6[]) = {
        3,
        29,
    };

    // Begin work for output row 0
    for (i = 0; i < 8; i++)
        temp[i + 0] = 29 * linearized[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 3 * linearized[i + 8];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 2; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,0
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 512;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 10)]);
    // Pixel 0,0 complete

    // Begin work for output pixel 1,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 2048;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 1,0 complete

    // Begin work for output pixel 2,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_2[i];
    sum = 2048;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 2,0 complete

    // Begin work for output pixel 3,0
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_3[i];
    sum = 2048;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 3,0 complete

    // Begin work for output pixel 4,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 2048;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 4,0 complete

    // Begin work for output pixel 5,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_5[i];
    sum = 2048;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 5)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 5,0 complete

    // Begin work for output pixel 6,0
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_6[i];
    sum = 512;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 6)
        = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 10)]);
    // Pixel 6,0 complete

    // Begin work for output row 1
    for (i = 0; i < 8; i++)
        temp[i + 0] = -2 * linearized[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 103 * linearized[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 27 * linearized[i + 16];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,1
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 0,1 complete

    // Begin work for output pixel 1,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 1,1 complete

    // Begin work for output pixel 2,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_2[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 2,1 complete

    // Begin work for output pixel 3,1
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 3,1 complete

    // Begin work for output pixel 4,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 4,1 complete

    // Begin work for output pixel 5,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_5[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 5)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 5,1 complete

    // Begin work for output pixel 6,1
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_6[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 6)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 6,1 complete

    // Begin work for output row 2
    for (i = 0; i < 8; i++)
        temp[i + 0] = -3 * linearized[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 86 * linearized[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 45 * linearized[i + 24];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,2
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 0,2 complete

    // Begin work for output pixel 1,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 1,2 complete

    // Begin work for output pixel 2,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_2[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 2,2 complete

    // Begin work for output pixel 3,2
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 3,2 complete

    // Begin work for output pixel 4,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 4,2 complete

    // Begin work for output pixel 5,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_5[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 5)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 5,2 complete

    // Begin work for output pixel 6,2
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_6[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 6)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 6,2 complete

    // Begin work for output row 3
    for (i = 0; i < 8; i++)
        temp[i + 0] = -3 * linearized[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 67 * linearized[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 67 * linearized[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 24] = -3 * linearized[i + 40];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,3
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 0,3 complete

    // Begin work for output pixel 1,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 1,3 complete

    // Begin work for output pixel 2,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_2[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 2,3 complete

    // Begin work for output pixel 3,3
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 3,3 complete

    // Begin work for output pixel 4,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 4,3 complete

    // Begin work for output pixel 5,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_5[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 5)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 5,3 complete

    // Begin work for output pixel 6,3
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_6[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 6)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 6,3 complete

    // Begin work for output row 4
    for (i = 0; i < 8; i++)
        temp[i + 0] = 45 * linearized[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 86 * linearized[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 16] = -3 * linearized[i + 48];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,4
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 0,4 complete

    // Begin work for output pixel 1,4
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 1,4 complete

    // Begin work for output pixel 2,4
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_2[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 2,4 complete

    // Begin work for output pixel 3,4
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 3,4 complete

    // Begin work for output pixel 4,4
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 4,4 complete

    // Begin work for output pixel 5,4
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_5[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 5)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 5,4 complete

    // Begin work for output pixel 6,4
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_6[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 6)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 6,4 complete

    // Begin work for output row 5
    for (i = 0; i < 8; i++)
        temp[i + 0] = 27 * linearized[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 103 * linearized[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 16] = -2 * linearized[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,5
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 0,5 complete

    // Begin work for output pixel 1,5
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 1,5 complete

    // Begin work for output pixel 2,5
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_2[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 2,5 complete

    // Begin work for output pixel 3,5
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 3,5 complete

    // Begin work for output pixel 4,5
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 4,5 complete

    // Begin work for output pixel 5,5
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_5[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 5)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 5,5 complete

    // Begin work for output pixel 6,5
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_6[i];
    sum = 2048;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 6)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 6,5 complete

    // Begin work for output row 6
    for (i = 0; i < 8; i++)
        temp[i + 0] = 3 * linearized[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 29 * linearized[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 2; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,6
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 512;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[6] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 10)]);
    // Pixel 0,6 complete

    // Begin work for output pixel 1,6
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 2048;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[6] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 1,6 complete

    // Begin work for output pixel 2,6
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_2[i];
    sum = 2048;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[6] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 2,6 complete

    // Begin work for output pixel 3,6
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_3[i];
    sum = 2048;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[6] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 3,6 complete

    // Begin work for output pixel 4,6
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 2048;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[6] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 4,6 complete

    // Begin work for output pixel 5,6
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_5[i];
    sum = 2048;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[6] + output_col + 5)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 5,6 complete

    // Begin work for output pixel 6,6
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_6[i];
    sum = 512;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[6] + output_col + 6)
        = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 10)]);
    // Pixel 6,6 complete
}

#ifndef FLOW_GCC_IDCT
void jpeg_idct_spatial_srgb_7x7(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JSAMPLE input[64];
    JSAMPROW rows[8] = { &input[0],     &input[8],     &input[8 * 2], &input[8 * 3],
                         &input[8 * 4], &input[8 * 5], &input[8 * 6], &input[8 * 7] };
    jpeg_idct_islow(cinfo, compptr, coef_block, &rows[0], 0);

    flow_scale_spatial_srgb_7x7(input, output_buf, output_col);
}
#endif

FLOW_EXPORT void flow_scale_spatial_srgb_6x6(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col)
{
    int32_t i, sum, j;
    FLOW_ALIGN_16_VAR(int32_t linearized[64]);
    for (i = 0; i < 64; i++)
        linearized[i] = lut_srgb_to_linear[input[i]];

    FLOW_ALIGN_16_VAR(int32_t temp[48]);
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_0[]) = {
        6,
        2,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_1[]) = {
        -1,
        33,
        33,
        -1,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_2[]) = {
        31,
        92,
        5,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_3[]) = {
        5,
        92,
        31,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_4[]) = {
        -1,
        33,
        33,
        -1,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_5[]) = {
        2,
        6,
    };

    // Begin work for output row 0
    for (i = 0; i < 8; i++)
        temp[i + 0] = 6 * linearized[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 2 * linearized[i + 8];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 2; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,0
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 32;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 262144 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 6)]);
    // Pixel 0,0 complete

    // Begin work for output pixel 1,0
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 256;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 2097152 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 9)]);
    // Pixel 1,0 complete

    // Begin work for output pixel 2,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 512;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 10)]);
    // Pixel 2,0 complete

    // Begin work for output pixel 3,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_3[i];
    sum = 512;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 10)]);
    // Pixel 3,0 complete

    // Begin work for output pixel 4,0
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 256;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 2097152 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 9)]);
    // Pixel 4,0 complete

    // Begin work for output pixel 5,0
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_5[i];
    sum = 32;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 5)
        = sum < 0 ? (uint8_t)0 : (sum >= 262144 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 6)]);
    // Pixel 5,0 complete

    // Begin work for output row 1
    for (i = 0; i < 8; i++)
        temp[i + 0] = -1 * linearized[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 33 * linearized[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 33 * linearized[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 24] = -1 * linearized[i + 24];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,1
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 256;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 2097152 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 9)]);
    // Pixel 0,1 complete

    // Begin work for output pixel 1,1
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 2048;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 1,1 complete

    // Begin work for output pixel 2,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 4096;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 13)]);
    // Pixel 2,1 complete

    // Begin work for output pixel 3,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_3[i];
    sum = 4096;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 13)]);
    // Pixel 3,1 complete

    // Begin work for output pixel 4,1
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 2048;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 4,1 complete

    // Begin work for output pixel 5,1
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_5[i];
    sum = 256;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 5)
        = sum < 0 ? (uint8_t)0 : (sum >= 2097152 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 9)]);
    // Pixel 5,1 complete

    // Begin work for output row 2
    for (i = 0; i < 8; i++)
        temp[i + 0] = 31 * linearized[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 92 * linearized[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 5 * linearized[i + 32];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,2
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 512;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 10)]);
    // Pixel 0,2 complete

    // Begin work for output pixel 1,2
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 13)]);
    // Pixel 1,2 complete

    // Begin work for output pixel 2,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 2,2 complete

    // Begin work for output pixel 3,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 3,2 complete

    // Begin work for output pixel 4,2
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 13)]);
    // Pixel 4,2 complete

    // Begin work for output pixel 5,2
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_5[i];
    sum = 512;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 5)
        = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 10)]);
    // Pixel 5,2 complete

    // Begin work for output row 3
    for (i = 0; i < 8; i++)
        temp[i + 0] = 5 * linearized[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 92 * linearized[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 31 * linearized[i + 40];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,3
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 512;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 10)]);
    // Pixel 0,3 complete

    // Begin work for output pixel 1,3
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 13)]);
    // Pixel 1,3 complete

    // Begin work for output pixel 2,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 2,3 complete

    // Begin work for output pixel 3,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 3,3 complete

    // Begin work for output pixel 4,3
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 13)]);
    // Pixel 4,3 complete

    // Begin work for output pixel 5,3
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_5[i];
    sum = 512;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 5)
        = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 10)]);
    // Pixel 5,3 complete

    // Begin work for output row 4
    for (i = 0; i < 8; i++)
        temp[i + 0] = -1 * linearized[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 33 * linearized[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 33 * linearized[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 24] = -1 * linearized[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,4
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 256;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 2097152 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 9)]);
    // Pixel 0,4 complete

    // Begin work for output pixel 1,4
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 2048;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 1,4 complete

    // Begin work for output pixel 2,4
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 4096;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 13)]);
    // Pixel 2,4 complete

    // Begin work for output pixel 3,4
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_3[i];
    sum = 4096;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 13)]);
    // Pixel 3,4 complete

    // Begin work for output pixel 4,4
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 2048;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 4,4 complete

    // Begin work for output pixel 5,4
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_5[i];
    sum = 256;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 5)
        = sum < 0 ? (uint8_t)0 : (sum >= 2097152 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 9)]);
    // Pixel 5,4 complete

    // Begin work for output row 5
    for (i = 0; i < 8; i++)
        temp[i + 0] = 2 * linearized[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 6 * linearized[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 2; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,5
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 32;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 262144 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 6)]);
    // Pixel 0,5 complete

    // Begin work for output pixel 1,5
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 256;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 2097152 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 9)]);
    // Pixel 1,5 complete

    // Begin work for output pixel 2,5
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 512;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 10)]);
    // Pixel 2,5 complete

    // Begin work for output pixel 3,5
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_3[i];
    sum = 512;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 4194304 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 10)]);
    // Pixel 3,5 complete

    // Begin work for output pixel 4,5
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_4[i];
    sum = 256;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 2097152 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 9)]);
    // Pixel 4,5 complete

    // Begin work for output pixel 5,5
    for (i = 0; i < 2; i++)
        temp[40 + i] = temp[38 + i] * weights_for_col_5[i];
    sum = 32;
    for (i = 0; i < 2; i++)
        sum += temp[40 + i];
    *(output_rows[5] + output_col + 5)
        = sum < 0 ? (uint8_t)0 : (sum >= 262144 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 6)]);
    // Pixel 5,5 complete
}

#ifndef FLOW_GCC_IDCT
void jpeg_idct_spatial_srgb_6x6(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JSAMPLE input[64];
    JSAMPROW rows[8] = { &input[0],     &input[8],     &input[8 * 2], &input[8 * 3],
                         &input[8 * 4], &input[8 * 5], &input[8 * 6], &input[8 * 7] };
    jpeg_idct_islow(cinfo, compptr, coef_block, &rows[0], 0);

    flow_scale_spatial_srgb_6x6(input, output_buf, output_col);
}
#endif

FLOW_EXPORT void flow_scale_spatial_srgb_5x5(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col)
{
    int32_t i, sum, j;
    FLOW_ALIGN_16_VAR(int32_t linearized[64]);
    for (i = 0; i < 64; i++)
        linearized[i] = lut_srgb_to_linear[input[i]];

    FLOW_ALIGN_16_VAR(int32_t temp[48]);
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_0[]) = {
        78,
        51,
        -1,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_1[]) = {
        -2,
        32,
        79,
        19,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_2[]) = {
        1,
        31,
        31,
        1,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_3[]) = {
        19,
        79,
        32,
        -2,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_4[]) = {
        -1,
        51,
        78,
    };

    // Begin work for output row 0
    for (i = 0; i < 8; i++)
        temp[i + 0] = 78 * linearized[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 51 * linearized[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 16] = -1 * linearized[i + 16];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 0,0 complete

    // Begin work for output pixel 1,0
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 1,0 complete

    // Begin work for output pixel 2,0
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 13)]);
    // Pixel 2,0 complete

    // Begin work for output pixel 3,0
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 3,0 complete

    // Begin work for output pixel 4,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 4,0 complete

    // Begin work for output row 1
    for (i = 0; i < 8; i++)
        temp[i + 0] = -2 * linearized[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 32 * linearized[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 79 * linearized[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 19 * linearized[i + 24];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 0,1 complete

    // Begin work for output pixel 1,1
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 1,1 complete

    // Begin work for output pixel 2,1
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 13)]);
    // Pixel 2,1 complete

    // Begin work for output pixel 3,1
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 3,1 complete

    // Begin work for output pixel 4,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 4,1 complete

    // Begin work for output row 2
    for (i = 0; i < 8; i++)
        temp[i + 0] = 1 * linearized[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 31 * linearized[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 31 * linearized[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 1 * linearized[i + 40];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 4096;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 13)]);
    // Pixel 0,2 complete

    // Begin work for output pixel 1,2
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 13)]);
    // Pixel 1,2 complete

    // Begin work for output pixel 2,2
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 2048;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 16777216 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 12)]);
    // Pixel 2,2 complete

    // Begin work for output pixel 3,2
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_3[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 13)]);
    // Pixel 3,2 complete

    // Begin work for output pixel 4,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_4[i];
    sum = 4096;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 13)]);
    // Pixel 4,2 complete

    // Begin work for output row 3
    for (i = 0; i < 8; i++)
        temp[i + 0] = 19 * linearized[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 79 * linearized[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 32 * linearized[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 24] = -2 * linearized[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 0,3 complete

    // Begin work for output pixel 1,3
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 1,3 complete

    // Begin work for output pixel 2,3
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 13)]);
    // Pixel 2,3 complete

    // Begin work for output pixel 3,3
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 3,3 complete

    // Begin work for output pixel 4,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 4,3 complete

    // Begin work for output row 4
    for (i = 0; i < 8; i++)
        temp[i + 0] = -1 * linearized[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 51 * linearized[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 78 * linearized[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,4
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 0,4 complete

    // Begin work for output pixel 1,4
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_1[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 1,4 complete

    // Begin work for output pixel 2,4
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[34 + i] * weights_for_col_2[i];
    sum = 4096;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 33554432 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 13)]);
    // Pixel 2,4 complete

    // Begin work for output pixel 3,4
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[36 + i] * weights_for_col_3[i];
    sum = 8192;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 3,4 complete

    // Begin work for output pixel 4,4
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_4[i];
    sum = 8192;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[4] + output_col + 4)
        = sum < 0 ? (uint8_t)0 : (sum >= 67108864 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 14)]);
    // Pixel 4,4 complete
}

#ifndef FLOW_GCC_IDCT
void jpeg_idct_spatial_srgb_5x5(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JSAMPLE input[64];
    JSAMPROW rows[8] = { &input[0],     &input[8],     &input[8 * 2], &input[8 * 3],
                         &input[8 * 4], &input[8 * 5], &input[8 * 6], &input[8 * 7] };
    jpeg_idct_islow(cinfo, compptr, coef_block, &rows[0], 0);

    flow_scale_spatial_srgb_5x5(input, output_buf, output_col);
}
#endif

FLOW_EXPORT void flow_scale_spatial_srgb_4x4(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col)
{
    int32_t i, sum, j;
    FLOW_ALIGN_16_VAR(int32_t linearized[64]);
    for (i = 0; i < 64; i++)
        linearized[i] = lut_srgb_to_linear[input[i]];

    FLOW_ALIGN_16_VAR(int32_t temp[48]);
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_0[]) = {
        117,
        117,
        22,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_1[]) = {
        21,
        107,
        107,
        21,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_2[]) = {
        21,
        107,
        107,
        21,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_3[]) = {
        22,
        117,
        117,
    };

    // Begin work for output row 0
    for (i = 0; i < 8; i++)
        temp[i + 0] = 117 * linearized[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 117 * linearized[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 22 * linearized[i + 16];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 0,0 complete

    // Begin work for output pixel 1,0
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 1,0 complete

    // Begin work for output pixel 2,0
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_2[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 2,0 complete

    // Begin work for output pixel 3,0
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_3[i];
    sum = 32768;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[0] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 3,0 complete

    // Begin work for output row 1
    for (i = 0; i < 8; i++)
        temp[i + 0] = 21 * linearized[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 107 * linearized[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 107 * linearized[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 21 * linearized[i + 32];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 0,1 complete

    // Begin work for output pixel 1,1
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 1,1 complete

    // Begin work for output pixel 2,1
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_2[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 2,1 complete

    // Begin work for output pixel 3,1
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_3[i];
    sum = 32768;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[1] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 3,1 complete

    // Begin work for output row 2
    for (i = 0; i < 8; i++)
        temp[i + 0] = 21 * linearized[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 107 * linearized[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 107 * linearized[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 21 * linearized[i + 48];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 0,2 complete

    // Begin work for output pixel 1,2
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 1,2 complete

    // Begin work for output pixel 2,2
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_2[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 2,2 complete

    // Begin work for output pixel 3,2
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_3[i];
    sum = 32768;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[2] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 3,2 complete

    // Begin work for output row 3
    for (i = 0; i < 8; i++)
        temp[i + 0] = 22 * linearized[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 117 * linearized[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 117 * linearized[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 3; j++)
            sum += temp[j * 8 + i];

        temp[32 + i] = sum;
    }
    // Begin work for output pixel 0,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[32 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 0,3 complete

    // Begin work for output pixel 1,3
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[33 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 1,3 complete

    // Begin work for output pixel 2,3
    for (i = 0; i < 4; i++)
        temp[40 + i] = temp[35 + i] * weights_for_col_2[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 2,3 complete

    // Begin work for output pixel 3,3
    for (i = 0; i < 3; i++)
        temp[40 + i] = temp[37 + i] * weights_for_col_3[i];
    sum = 32768;
    for (i = 0; i < 3; i++)
        sum += temp[40 + i];
    *(output_rows[3] + output_col + 3)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 3,3 complete
}

#ifndef FLOW_GCC_IDCT
void jpeg_idct_spatial_srgb_4x4(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JSAMPLE input[64];
    JSAMPROW rows[8] = { &input[0],     &input[8],     &input[8 * 2], &input[8 * 3],
                         &input[8 * 4], &input[8 * 5], &input[8 * 6], &input[8 * 7] };
    jpeg_idct_islow(cinfo, compptr, coef_block, &rows[0], 0);

    flow_scale_spatial_srgb_4x4(input, output_buf, output_col);
}
#endif

FLOW_EXPORT void flow_scale_spatial_srgb_3x3(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col)
{
    int32_t i, sum, j;
    FLOW_ALIGN_16_VAR(int32_t linearized[64]);
    for (i = 0; i < 64; i++)
        linearized[i] = lut_srgb_to_linear[input[i]];

    FLOW_ALIGN_16_VAR(int32_t temp[64]);
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_0[]) = {
        80,
        103,
        62,
        11,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_1[]) = {
        2, 39, 87, 87, 39, 2,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_2[]) = {
        11,
        62,
        103,
        80,
    };

    // Begin work for output row 0
    for (i = 0; i < 8; i++)
        temp[i + 0] = 80 * linearized[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 103 * linearized[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 62 * linearized[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 11 * linearized[i + 24];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[48 + i] = sum;
    }
    // Begin work for output pixel 0,0
    for (i = 0; i < 4; i++)
        temp[56 + i] = temp[48 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[56 + i];
    *(output_rows[0] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 0,0 complete

    // Begin work for output pixel 1,0
    for (i = 0; i < 6; i++)
        temp[56 + i] = temp[49 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 6; i++)
        sum += temp[56 + i];
    *(output_rows[0] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 1,0 complete

    // Begin work for output pixel 2,0
    for (i = 0; i < 4; i++)
        temp[56 + i] = temp[52 + i] * weights_for_col_2[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[56 + i];
    *(output_rows[0] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 2,0 complete

    // Begin work for output row 1
    for (i = 0; i < 8; i++)
        temp[i + 0] = 2 * linearized[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 39 * linearized[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 87 * linearized[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 87 * linearized[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 32] = 39 * linearized[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 40] = 2 * linearized[i + 48];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 6; j++)
            sum += temp[j * 8 + i];

        temp[48 + i] = sum;
    }
    // Begin work for output pixel 0,1
    for (i = 0; i < 4; i++)
        temp[56 + i] = temp[48 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[56 + i];
    *(output_rows[1] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 0,1 complete

    // Begin work for output pixel 1,1
    for (i = 0; i < 6; i++)
        temp[56 + i] = temp[49 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 6; i++)
        sum += temp[56 + i];
    *(output_rows[1] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 1,1 complete

    // Begin work for output pixel 2,1
    for (i = 0; i < 4; i++)
        temp[56 + i] = temp[52 + i] * weights_for_col_2[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[56 + i];
    *(output_rows[1] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 2,1 complete

    // Begin work for output row 2
    for (i = 0; i < 8; i++)
        temp[i + 0] = 11 * linearized[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 62 * linearized[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 103 * linearized[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 80 * linearized[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 4; j++)
            sum += temp[j * 8 + i];

        temp[48 + i] = sum;
    }
    // Begin work for output pixel 0,2
    for (i = 0; i < 4; i++)
        temp[56 + i] = temp[48 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[56 + i];
    *(output_rows[2] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 0,2 complete

    // Begin work for output pixel 1,2
    for (i = 0; i < 6; i++)
        temp[56 + i] = temp[49 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 6; i++)
        sum += temp[56 + i];
    *(output_rows[2] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 1,2 complete

    // Begin work for output pixel 2,2
    for (i = 0; i < 4; i++)
        temp[56 + i] = temp[52 + i] * weights_for_col_2[i];
    sum = 32768;
    for (i = 0; i < 4; i++)
        sum += temp[56 + i];
    *(output_rows[2] + output_col + 2)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 2,2 complete
}

#ifndef FLOW_GCC_IDCT
void jpeg_idct_spatial_srgb_3x3(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JSAMPLE input[64];
    JSAMPROW rows[8] = { &input[0],     &input[8],     &input[8 * 2], &input[8 * 3],
                         &input[8 * 4], &input[8 * 5], &input[8 * 6], &input[8 * 7] };
    jpeg_idct_islow(cinfo, compptr, coef_block, &rows[0], 0);

    flow_scale_spatial_srgb_3x3(input, output_buf, output_col);
}
#endif

FLOW_EXPORT void flow_scale_spatial_srgb_2x2(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col)
{
    int32_t i, sum, j;
    FLOW_ALIGN_16_VAR(int32_t linearized[64]);
    for (i = 0; i < 64; i++)
        linearized[i] = lut_srgb_to_linear[input[i]];

    FLOW_ALIGN_16_VAR(int32_t temp[64]);
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_0[]) = {
        48, 67, 67, 48, 22, 4,
    };
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_1[]) = {
        4, 22, 48, 67, 67, 48,
    };

    // Begin work for output row 0
    for (i = 0; i < 8; i++)
        temp[i + 0] = 48 * linearized[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 67 * linearized[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 67 * linearized[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 48 * linearized[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 32] = 22 * linearized[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 40] = 4 * linearized[i + 40];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 6; j++)
            sum += temp[j * 8 + i];

        temp[48 + i] = sum;
    }
    // Begin work for output pixel 0,0
    for (i = 0; i < 6; i++)
        temp[56 + i] = temp[48 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 6; i++)
        sum += temp[56 + i];
    *(output_rows[0] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 0,0 complete

    // Begin work for output pixel 1,0
    for (i = 0; i < 6; i++)
        temp[56 + i] = temp[50 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 6; i++)
        sum += temp[56 + i];
    *(output_rows[0] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 1,0 complete

    // Begin work for output row 1
    for (i = 0; i < 8; i++)
        temp[i + 0] = 4 * linearized[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 22 * linearized[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 48 * linearized[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 67 * linearized[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 32] = 67 * linearized[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 40] = 48 * linearized[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 6; j++)
            sum += temp[j * 8 + i];

        temp[48 + i] = sum;
    }
    // Begin work for output pixel 0,1
    for (i = 0; i < 6; i++)
        temp[56 + i] = temp[48 + i] * weights_for_col_0[i];
    sum = 32768;
    for (i = 0; i < 6; i++)
        sum += temp[56 + i];
    *(output_rows[1] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 0,1 complete

    // Begin work for output pixel 1,1
    for (i = 0; i < 6; i++)
        temp[56 + i] = temp[50 + i] * weights_for_col_1[i];
    sum = 32768;
    for (i = 0; i < 6; i++)
        sum += temp[56 + i];
    *(output_rows[1] + output_col + 1)
        = sum < 0 ? (uint8_t)0 : (sum >= 268435456 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 16)]);
    // Pixel 1,1 complete
}

#ifndef FLOW_GCC_IDCT
void jpeg_idct_spatial_srgb_2x2(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JSAMPLE input[64];
    JSAMPROW rows[8] = { &input[0],     &input[8],     &input[8 * 2], &input[8 * 3],
                         &input[8 * 4], &input[8 * 5], &input[8 * 6], &input[8 * 7] };
    jpeg_idct_islow(cinfo, compptr, coef_block, &rows[0], 0);

    flow_scale_spatial_srgb_2x2(input, output_buf, output_col);
}
#endif

FLOW_EXPORT void flow_scale_spatial_srgb_1x1(uint8_t input[64], uint8_t ** output_rows, uint32_t output_col)
{
    int32_t i, sum, j;
    FLOW_ALIGN_16_VAR(int32_t linearized[64]);
    for (i = 0; i < 64; i++)
        linearized[i] = lut_srgb_to_linear[input[i]];

    FLOW_ALIGN_16_VAR(int32_t temp[80]);
    FLOW_ALIGN_16_VAR(int32_t weights_for_col_0[]) = {
        47, 60, 71, 78, 78, 71, 60, 47,
    };

    // Begin work for output row 0
    for (i = 0; i < 8; i++)
        temp[i + 0] = 47 * linearized[i + 0];
    for (i = 0; i < 8; i++)
        temp[i + 8] = 60 * linearized[i + 8];
    for (i = 0; i < 8; i++)
        temp[i + 16] = 71 * linearized[i + 16];
    for (i = 0; i < 8; i++)
        temp[i + 24] = 78 * linearized[i + 24];
    for (i = 0; i < 8; i++)
        temp[i + 32] = 78 * linearized[i + 32];
    for (i = 0; i < 8; i++)
        temp[i + 40] = 71 * linearized[i + 40];
    for (i = 0; i < 8; i++)
        temp[i + 48] = 60 * linearized[i + 48];
    for (i = 0; i < 8; i++)
        temp[i + 56] = 47 * linearized[i + 56];
    for (i = 0; i < 8; i++) {
        sum = 0;
        for (j = 0; j < 8; j++)
            sum += temp[j * 8 + i];

        temp[64 + i] = sum;
    }
    // Begin work for output pixel 0,0
    for (i = 0; i < 8; i++)
        temp[72 + i] = temp[64 + i] * weights_for_col_0[i];
    sum = 131072;
    for (i = 0; i < 8; i++)
        sum += temp[72 + i];
    *(output_rows[0] + output_col + 0)
        = sum < 0 ? (uint8_t)0 : (sum >= 1073741824 ? (uint8_t)255 : (uint8_t)lut_linear_to_srgb[(sum >> 18)]);
    // Pixel 0,0 complete
}

#ifndef FLOW_GCC_IDCT
void jpeg_idct_spatial_srgb_1x1(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JSAMPLE input[64];
    JSAMPROW rows[8] = { &input[0],     &input[8],     &input[8 * 2], &input[8 * 3],
                         &input[8 * 4], &input[8 * 5], &input[8 * 6], &input[8 * 7] };
    jpeg_idct_islow(cinfo, compptr, coef_block, &rows[0], 0);

    flow_scale_spatial_srgb_1x1(input, output_buf, output_col);
}
#endif

#ifdef FLOW_GCC_IDCT
void main(void) {}
#endif
